name: Auto optimize images

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  optimize:
    name: Optimize changed images under assets/
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install image tools
        run: |
          sudo apt-get update
          sudo apt-get install -y optipng jpegoptim pngquant

      - name: Optimize changed assets
        run: |
          set -euo pipefail
          # get changed files compared to main
          CHANGED=$(git diff --name-only origin/main...HEAD || true)
          echo "Changed files: $CHANGED"

          FOUND=0
          SUMMARY=""

          for f in $(echo "$CHANGED" | tr '\n' ' '); do
            case "$f" in
              assets/*.png)
                if [ -f "$f" ]; then
                  before=$(stat -c%s "$f")
                  optipng -o2 "$f" >/dev/null 2>&1 || true
                  pngquant --force --output "$f" -- "$f" >/dev/null 2>&1 || true
                  after=$(stat -c%s "$f")
                  if [ "$after" -lt "$before" ]; then
                    SUMMARY="$SUMMARY\n$f: $before -> $after"
                    FOUND=1
                  fi
                fi
                ;;
              assets/*.jpg|assets/*.jpeg)
                if [ -f "$f" ]; then
                  before=$(stat -c%s "$f")
                  jpegoptim --strip-all --all-progressive "$f" >/dev/null 2>&1 || true
                  after=$(stat -c%s "$f")
                  if [ "$after" -lt "$before" ]; then
                    SUMMARY="$SUMMARY\n$f: $before -> $after"
                    FOUND=1
                  fi
                fi
                ;;
              *)
                ;;
            esac
          done

          if [ "$FOUND" -eq 1 ]; then
            echo -e "Optimized files:$SUMMARY"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: auto-optimize images in assets" || echo "No commit (maybe no changes)"
            git push || echo "Push failed (check permissions)"
          else
            echo "No images optimized."
          fi
